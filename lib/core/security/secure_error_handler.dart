import 'package:flutter/foundation.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

/// Ù…Ø¹Ø§Ù„Ø¬ Ø¢Ù…Ù† Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ ÙŠÙ…Ù†Ø¹ ØªØ³Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
class SecureErrorHandler {
  
  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø±Ø³Ø§Ø¦Ù„ Ø¢Ù…Ù†Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  static String getSafeErrorMessage(dynamic error) {
    if (kDebugMode) {
      // ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
      print('ğŸ› Debug Error: $error');
    }
    
    // ØªØ­Ù„ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø±Ø³Ø§Ù„Ø© Ø¢Ù…Ù†Ø©
    if (error is AuthException) {
      return _handleAuthError(error);
    } else if (error is PostgrestException) {
      return _handleDatabaseError(error);
    } else if (error is StorageException) {
      return _handleStorageError(error);
    } else if (error is Exception) {
      return _handleGenericError(error);
    } else {
      return 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
    }
  }
  
  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
  static String _handleAuthError(AuthException error) {
    switch (error.statusCode) {
      case '400':
        if (error.message.contains('Invalid login credentials')) {
          return 'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
        } else if (error.message.contains('Email not confirmed')) {
          return 'ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹';
        } else if (error.message.contains('Invalid email')) {
          return 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
        }
        return 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©';
      
      case '401':
        return 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø¬Ù„Ø³ØªÙƒØŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
      
      case '403':
        return 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©';
      
      case '422':
        if (error.message.contains('Email rate limit exceeded')) {
          return 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹';
        }
        return 'Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      
      case '429':
        return 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø·Ù„Ø¨Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹';
      
      default:
        return 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
    }
  }
  
  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  static String _handleDatabaseError(PostgrestException error) {
    final message = error.message.toLowerCase();
    
    if (message.contains('permission denied') || 
        message.contains('row level security') ||
        message.contains('policy')) {
      return 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    } else if (message.contains('duplicate key') || 
               message.contains('unique constraint')) {
      return 'Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹';
    } else if (message.contains('foreign key') || 
               message.contains('violates')) {
      return 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø³Ø¨Ø¨ Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    } else if (message.contains('not found')) {
      return 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©';
    } else if (message.contains('connection') || 
               message.contains('timeout')) {
      return 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
    } else {
      return 'Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
    }
  }
  
  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ®Ø²ÙŠÙ†
  static String _handleStorageError(StorageException error) {
    final message = error.message.toLowerCase();
    
    if (message.contains('file too large') || 
        message.contains('size')) {
      return 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹';
    } else if (message.contains('invalid file type') || 
               message.contains('format')) {
      return 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…';
    } else if (message.contains('permission') || 
               message.contains('access')) {
      return 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª';
    } else {
      return 'Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
    }
  }
  
  /// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
  static String _handleGenericError(Exception error) {
    final message = error.toString().toLowerCase();
    
    if (message.contains('network') || 
        message.contains('connection') ||
        message.contains('internet')) {
      return 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
    } else if (message.contains('timeout')) {
      return 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
    } else if (message.contains('format') || 
               message.contains('parse')) {
      return 'Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    } else {
      return 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
    }
  }
  
  /// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£Ù…Ù†ÙŠØ© (Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©)
  static void logSecurityEvent(String event, Map<String, dynamic>? details) {
    if (kDebugMode) {
      print('ğŸ”’ Security Event: $event');
      if (details != null) {
        print('ğŸ“‹ Details: $details');
      }
    }
    
    // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø®Ø¯Ù…Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø«Ù„ Sentry
    // Sentry.captureMessage('Security Event: $event', level: SentryLevel.warning);
  }
  
  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
  static bool isValidInput(String input, {int maxLength = 1000}) {
    if (input.isEmpty || input.length > maxLength) {
      return false;
    }
    
    // Ù…Ù†Ø¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¶Ø§Ø±Ø©
    final dangerousPatterns = [
      '<script',
      'javascript:',
      'onload=',
      'onerror=',
      'eval(',
      'document.cookie',
      'localStorage',
      'sessionStorage',
    ];
    
    final lowerInput = input.toLowerCase();
    for (final pattern in dangerousPatterns) {
      if (lowerInput.contains(pattern)) {
        logSecurityEvent('Dangerous input detected', {'input': input});
        return false;
      }
    }
    
    return true;
  }
  
  /// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¶Ø§Ø±Ø©
  static String sanitizeInput(String input) {
    return input
        .replaceAll(RegExp(r'<[^>]*>'), '') // Ø¥Ø²Ø§Ù„Ø© HTML tags
        .replaceAll(RegExp(r'[<>"\']'), '') // Ø¥Ø²Ø§Ù„Ø© Ø£Ø­Ø±Ù Ø®Ø·ÙŠØ±Ø©
        .trim();
  }
  
  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
  static bool isValidEmail(String email) {
    final emailRegex = RegExp(
      r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    );
    return emailRegex.hasMatch(email) && email.length <= 254;
  }
  
  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
  static bool isValidPhoneNumber(String phone) {
    final phoneRegex = RegExp(r'^\+?[1-9]\d{1,14}$');
    return phoneRegex.hasMatch(phone.replaceAll(RegExp(r'[\s\-\(\)]'), ''));
  }
}

/// Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª Ù…Ø®ØµØµØ© Ù„Ù„Ø£Ù…Ø§Ù†
class SecurityException implements Exception {
  final String message;
  final String? code;
  
  const SecurityException(this.message, {this.code});
  
  @override
  String toString() => 'SecurityException: $message';
}

class InsufficientPermissionsException extends SecurityException {
  const InsufficientPermissionsException() 
      : super('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', code: 'INSUFFICIENT_PERMISSIONS');
}

class InvalidInputException extends SecurityException {
  const InvalidInputException(String message) 
      : super(message, code: 'INVALID_INPUT');
}

class RateLimitExceededException extends SecurityException {
  const RateLimitExceededException() 
      : super('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø·Ù„Ø¨Ø§Øª', code: 'RATE_LIMIT_EXCEEDED');
}
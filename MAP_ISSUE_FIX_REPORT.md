# تقرير إصلاح مشكلة الخريطة للمتطوعين

## المشكلة
الخريطة لا تظهر للمتطوع بسبب عدم وجود أعمدة `latitude` و `longitude` في جدول التبرعات.

## السبب الجذري
- بيانات الموقع مخزنة في عمود `location` من نوع PostGIS `geography(Point, 4326)`
- الكود كان يحاول الوصول مباشرة لأعمدة `latitude` و `longitude` غير الموجودة
- لم يتم استخدام الدوال المساعدة لاستخراج الإحداثيات من عمود `location`

## الحلول المطبقة

### 1. تحديث خدمة المتطوع (VolunteerService)
- إضافة دالة جديدة `getDonationsForMap()` تستخدم الدالة المخصصة `get_map_data_with_coordinates`
- إضافة آلية احتياطية لاستخراج الإحداثيات باستخدام دوال PostGIS
- معالجة أفضل للأخطاء

### 2. تحديث صفحة خريطة التبرعات (DonationsMapPage)
- استخدام الدالة الجديدة `getDonationsForMap()` بدلاً من `getAvailableDonations()`
- تحسين معالجة البيانات لاستخراج الإحداثيات
- إضافة حالات تحميل وخطأ أفضل
- إضافة زر تحديث
- معالجة فشل تحميل الأيقونات المخصصة

### 3. الدوال المتاحة في قاعدة البيانات
الدوال التالية متاحة ومُعدة مسبقاً:
- `get_latitude_from_location(geography)` - لاستخراج خط العرض
- `get_longitude_from_location(geography)` - لاستخراج خط الطول  
- `get_map_data_with_coordinates(text, uuid)` - للحصول على بيانات الخريطة مع الإحداثيات
- `donations_with_coordinates` view - عرض التبرعات مع الإحداثيات

## الملفات المُحدثة

### `lib/volunteer/services/volunteer_service.dart`
- إضافة دالة `getDonationsForMap()`
- معالجة أخطاء أفضل مع آلية احتياطية

### `lib/volunteer/donations_map_page.dart`
- تحديث منطق جلب البيانات
- تحسين واجهة المستخدم
- إضافة حالات التحميل والخطأ
- إضافة زر التحديث

## النتيجة
- الخريطة تعمل الآن بشكل صحيح للمتطوعين
- عرض التبرعات المتاحة مع مواقعها على الخريطة
- معالجة أفضل للأخطاء والحالات الاستثنائية
- تجربة مستخدم محسنة مع رسائل واضحة

## اختبار الحل
1. تسجيل الدخول كمتطوع
2. الانتقال لصفحة الخريطة من التنقل السفلي
3. التأكد من ظهور التبرعات المتاحة على الخريطة
4. اختبار زر التحديث
5. التأكد من ظهور رسائل مناسبة في حالة عدم وجود تبرعات

## ملاحظات تقنية
- تم استخدام PostGIS لمعالجة البيانات الجغرافية
- الحل يدعم كل من الدوال المخصصة والاستخراج اليدوي للإحداثيات
- تم تحسين الأداء باستخدام دوال قاعدة البيانات المحسنة
- الكود يتعامل مع فشل تحميل الأيقونات المخصصة بأيقونات افتراضية